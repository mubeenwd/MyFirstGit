<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/jquery.mobile.flatui.css" />
    <script src="js/jquery.min.js" charset="utf-8" type="text/javascript"></script>
    <script src="js/jquery.mobile-1.3.1.min.js" charset="utf-8" type="text/javascript"></script>
    <script src="phonegap.js" charset="utf-8" type="text/javascript"></script>
    <!--<script charset="utf-8" type="text/javascript" src="js/json2.min.js"></script>
    <script charset="utf-8" type="text/javascript" src="js/phonegap.facebook.inappbrowser.js"></script>-->
    <!-- <script charset="utf-8" type="text/javascript">

                var my_client_id = "220567994647036", // YOUR APP ID
                my_secret = "08b47fdd154c4f9a9fc343a59eb2c514", // YOUR APP SECRET 
                my_redirect_uri = "https://www.facebook.com/connect/login_success.html", // LEAVE THIS
                my_type = "user_agent", my_display = "touch";  // LEAVE THIS

                var facebook_token = "fbToken"; // OUR TOKEN KEEPER
                var ref; //IN APP BROWSER REFERENCE

                // FACEBOOK
                var Facebook = {
                    init: function () {
                        // Begin Authorization
                        var authorize_url = "https://www.facebook.com/dialog/oauth?";
                        authorize_url += "client_id=" + my_client_id;
                        authorize_url += "&redirect_uri=" + my_redirect_uri;
                        authorize_url += "&display=" + my_display;
                        authorize_url += "&scope=publish_stream";

                        //CALL IN APP BROWSER WITH THE LINK
                        ref = window.open(authorize_url, '_blank', 'location=no');

                        ref.addEventListener('loadstart', function (event) {

                            Facebook.facebookLocChanged(event.url);

                        });

                    },
                    facebookLocChanged: function (loc) {

                        if (loc.indexOf("code=") >= 1) {

                            //THIS IS MEANT TO BE DONE ON SERVER SIDE TO PROTECT CLIENT SECRET
                            var codeUrl = 'https://graph.facebook.com/oauth/access_token?client_id=' + my_client_id + '&client_secret=' + my_secret + '&redirect_uri=' + my_redirect_uri + '&code=' + loc.split("=")[1];
                            console.log('CODE_URL::' + codeUrl);
                            $.ajax({
                                url: codeUrl,
                                data: {},
                                type: 'POST',
                                async: false,
                                cache: false,
                                success: function (data, status) {
                                    //WE STORE THE TOKEN HERE
                                    localStorage.setItem(facebook_token, data.split('=')[1].split('&')[0]);
                                    alert(localStorage.getItem(facebook_token));
                                },
                                error: function () {
                                    alert("Unknown error Occured");
                                }
                            });
                        }
                    }
                    //                    ,facebookGetInfo: function (accessToken) {
                    //                        var get_url = "https://graph.facebook.com/" + accessToken;
                    //                        $.ajax({
                    //                            url: get_url,
                    //                            data: {},
                    //                            type: 'POST',
                    //                            async: false,
                    //                            cache: false,
                    //                            success: function (data, status) {
                    //                                if (data != null) {
                    //                                    if (data!=undefined) {
                    //                                        localStorage.setItem("id", data["id"]);
                    //                                        localStorage.setItem("name", data["name"]);
                    //                                        localStorage.setItem("first_name", data["first_name"]);
                    //                                        localStorage.setItem("last_name", data["last_name"]);
                    //                                        localStorage.setItem("username", data["username"]);
                    //                                        localStorage.setItem("gender", data["gender"]);
                    //                                    }
                    //                                }
                    //                            },
                    //                            error: function () {
                    //                                alert("Unknown error Occured");
                    //                            }
                    //                        });

                    //                        //CLOSE INAPPBROWSER AND NAVIGATE TO INDEX
                    //                        ref.close();
                    //                    }
                //}

                function onLoad() {
                    document.addEventListener("deviceready", onDeviceReady, false);
                }

                function onDeviceReady() {
                    
                }

                function openProfile() {
                    $.mobile.changePage('#profile', {
                        changeHash: true,
                        transition: "slide"
                    })
                }

                function openBrowser() {
                    Facebook.init();
                    $.mobile.changePage('#profile', {
                        changeHash: true,
                        transition: "slide"
                    });
                }

                function openIndex() {
                    $.mobile.changePage('#index', {
                        changeHash: true,
                        transition: "slide"
                    });
                }
    </script>
    <script type="text/javascript" charset="utf-8">
        FacebookInAppBrowser.settings.appId = '220567994647036';
        FacebookInAppBrowser.settings.redirectUrl = 'https://www.facebook.com/connect/login_success.html';
        FacebookInAppBrowser.settings.permissions = 'publish_stream';

        function loginSuccessCallback() {
            alert('loginSuccessCallback');
        }

        function loginUnknowErrorCallback() {
            alert('loginUnknowErrorCallback');
        }

        function userIdCallback() {
            alert('userIdCallback');
        }

        function OpenBrowser() {
            FacebookInAppBrowser.login(loginSuccessCallback, loginUnknowErrorCallback, userIdCallback);

            // Same logic of callbacks
            FacebookInAppBrowser.getInfo(function (response) {
                if (response) {
                    var name = response.name,
                    id = response.id,
                    gender = response.gender;
                    first_name = response.first_name;
                    last_name = response.last_name;
                    username = response.username;

                    localStorage.setItem("id", id);
                    localStorage.setItem("name", name);
                    localStorage.setItem("first_name", first_name);
                    localStorage.setItem("last_name", last_name);
                    localStorage.setItem("username", username);
                    localStorage.setItem("gender", gender);
                }
            });
        }

        function openProfile() {
            $.mobile.changePage('#profile', {
                changeHash: true,
                transition: "slide"
            });
        }

        function openIndex() {
            $.mobile.changePage('#index', {
                changeHash: true,
                transition: "slide"
            });
        }


        function Invite(inviteText) {
            FacebookInAppBrowser.invite(inviteText, function () { alert("invited"); });
        }
    </script>-->
    <script charset="utf-8" type="text/javascript">
        var fbapi = {
            authorize: function (options) {

                var deferred = $.Deferred();

                //Build the OAuth consent page URL
                var authUrl = 'https://www.facebook.com/dialog/oauth?' + $.param({
                    client_id: options.client_id,
                    redirect_uri: options.redirect_uri
                });

                alert('about to open InAppBrowser with URL: ' + authUrl);

                //Open the OAuth consent page in the InAppBrowser
                var authWindow = window.open(authUrl, '_blank', 'location=no,toolbar=no');

                $(authWindow).on('loadstart', function (e) {
                    var url = e.originalEvent.url;

                    alert('InAppBrowser: loadstart event has fired with url: ' + url);

                    var code = /\?code=(.+)$/.exec(url);
                    var error = /\?error=(.+)$/.exec(url);

                    if (code || error) {
                        //Always close the browser when match is found
                        authWindow.close();
                    }

                    if (code) {
                        //Exchange the authorization code for an access token
                        $.post('https://graph.facebook.com/oauth/access_token', {
                            code: code[1],
                            client_id: options.client_id,
                            client_secret: options.client_secret,
                            redirect_uri: options.redirect_uri
                        }).done(function (data) {
                            deferred.resolve(data);
                        }).fail(function (response) {
                            deferred.reject(response.responseJSON);
                        });
                    } else if (error) {
                        //The user denied access to the app
                        deferred.reject({
                            error: error[1]
                        });
                    }
                });
                return deferred.promise();
            },

            profile: function (access_token) {
                var deferred = $.Deferred();

                //Build the OAuth consent page URL
                var profile_uri = 'https://graph.facebook.com/me?' + access_token;

                alert('about to fetch facebook profile: ' + profile_uri);

                $.getJSON(profile_uri)
                .done(function (data) {
                    deferred.resolve(data);
                }).fail(function (response) {
                    deferred.reject(response.responseJSON);
                });

                return deferred.promise();
            }
        };

        $(document).on('deviceready', function () {

            //enable cross site script
            jQuery.support.cors = true;

            var $loginButton = $('#btnLogin');
            var $loginStatus = $('#prLoginStatus');

            $loginButton.on('click', function () {

                $.when(fbapi.authorize({
                    client_id: '220567994647036',
                    client_secret: '08b47fdd154c4f9a9fc343a59eb2c514',
                    redirect_uri: 'http://www.lbtconsuting.in/'
                }))
                .then(function (access_token) {
                    alert('Executing then callback with access token: ' + access_token); fbapi.profile(access_token).done(function (data) {
                        console.log('facebook response' + JSON.stringify(data));
                        $loginStatus.html('Welcome ' + data.name + '. Your Facebook user id is ' + data.id);
                        $loginButton.hide();
                    }).fail(function (data) {
                        $loginStatus.html(data.error);
                    });
                });
            });

            $("#btnHome").bind("tap", function () {
                $.mobile.changePage('#index', {
                    changeHash: true,
                    transition: "slide"
                });
            });

            $("#btnProfile").bind("tap", function () {
                $.mobile.changePage('#profile', {
                    changeHash: true,
                    transition: "slide"
                });
            });
        });
    </script>
    <style type="text/css">
        .my-grid-blocks
        {
            padding: 1%;
            margin: 1%;
        }
    </style>
</head>
<body onload="onLoad()">
    <div data-role="page" id="index">
        <div data-role="panel" id="panel" data-position="right" data-theme="a" data-display="push">
        </div>
        <div data-role="header">
            <a data-iconpos="notext" data-role="button" data-icon="home" title="Home" id="btnHome">
                Home</a>
            <h1>
                The Best status</h1>
            <a data-iconpos="notext" href="#panel" data-role="button" data-icon="flat-menu" id="btnMenu">
            </a>
        </div>
        <div data-role="content" style="padding-left:5%;padding-right:5%;">
            <button data-icon="flat-settings" data-theme="d" id="btnLogin">
                Face Book Login</button>
                 <button data-icon="flat-settings" data-theme="b" id="btnProfile">
                Face Book Profile</button>
            <p id="prLoginStatus">
            </p>
        </div>
    </div>
    <div id="highlight">
    </div>
    <div data-role="page" id="profile">
        <div data-role="panel" id="Div1" data-position="right" data-theme="a" data-display="push">
        </div>
        <div data-role="header">
            <a data-iconpos="notext" data-role="button" data-icon="home" title="Home" href="index.html">
                Home</a>
            <h1>
                Your profile</h1>
            <a data-iconpos="notext" href="#panel" data-role="button" data-icon="flat-menu">
            </a>
        </div>
        <div data-role="content" role="main">
            <div class="ui-grid-b">
                <div class="ui-block-a">
                    <div class="my-grid-blocks">
                        Block A
                    </div>
                </div>
                <div class="ui-block-b">
                    <div class="my-grid-blocks">
                        Block B
                    </div>
                </div>
                <div class="ui-block-c">
                    <div class="my-grid-blocks">
                        Block C
                    </div>
                </div>
            </div>
            <p>
                <ul data-role="listview" id="profilelistview">
                </ul>
            </p>
        </div>
    </div>
</body>
</html>
